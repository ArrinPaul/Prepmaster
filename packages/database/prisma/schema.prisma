generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════
// USER MANAGEMENT & AUTHENTICATION
// ═══════════════════════════════════════════════════════════════════════

enum Role {
  USER
  ADMIN
  MODERATOR
  INSTRUCTOR
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique @db.VarChar(255)
  emailVerified        DateTime?
  name                 String    @db.VarChar(255)
  username             String?   @unique @db.VarChar(100)
  avatar               String?   @db.Text
  bio                  String?   @db.Text
  location             String?   @db.VarChar(255)
  website              String?   @db.VarChar(255)
  githubUrl            String?   @db.VarChar(255)
  linkedinUrl          String?   @db.VarChar(255)
  twitterUrl           String?   @db.VarChar(255)
  
  // Authentication
  password             String?   @db.VarChar(255)
  role                 Role      @default(USER)
  plan                 Plan      @default(FREE)
  
  // Gamification
  credits              Int       @default(10)
  currentStreak        Int       @default(0)
  longestStreak        Int       @default(0)
  totalPoints          Int       @default(0)
  interviewsCompleted  Int       @default(0)
  problemsSolved       Int       @default(0)
  
  // Billing
  stripeCustomerId     String?   @unique @db.VarChar(255)
  stripeSubscriptionId String?   @unique @db.VarChar(255)
  subscriptionEndsAt   DateTime?
  
  // Security
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String?   @db.VarChar(255)
  twoFactorBackupCodes String[]
  
  // Status
  lastLoginAt          DateTime?
  lastActivityAt       DateTime?
  isActive             Boolean   @default(true)
  isBlocked            Boolean   @default(false)
  blockedReason        String?   @db.Text
  
  // Timestamps
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?
  
  // Relations
  accounts             Account[]
  sessions             Session[]
  refreshTokens        RefreshToken[]
  userPreferences      UserPreference?

  @@index([email])
  @@index([username])
  @@index([plan])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

// OAuth Accounts (Google, GitHub, LinkedIn, etc.)
model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String   @db.VarChar(100)
  provider          String   @db.VarChar(100)
  providerAccountId String   @db.VarChar(255)
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?  @db.VarChar(100)
  scope             String?  @db.Text
  id_token          String?  @db.Text
  session_state     String?  @db.VarChar(255)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// Sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @db.VarChar(255)
  userId       String
  expires      DateTime
  userAgent    String?  @db.Text
  ipAddress    String?  @db.VarChar(45)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

// JWT Refresh Tokens
model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique @db.VarChar(500)
  userId    String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// User Preferences
model UserPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // UI Preferences
  theme                 String   @default("dark")
  language              String   @default("en")
  timezone              String   @default("UTC")
  
  // Notifications
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(true)
  interviewReminders    Boolean  @default(true)
  streakReminders       Boolean  @default(true)
  newFeatureEmails      Boolean  @default(true)
  marketingEmails       Boolean  @default(false)
  weeklyDigest          Boolean  @default(true)
  
  // Privacy
  activityPrivacy       String   @default("public")
  profileVisibility     String   @default("public")
  allowMessages         Boolean  @default(true)
  showStats             Boolean  @default(true)
  showLeaderboard       Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

// ═══════════════════════════════════════════════════════════════════════
// SYSTEM TABLES
// ═══════════════════════════════════════════════════════════════════════

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique @db.VarChar(255)
  value     String   @db.Text
  type      String   @db.VarChar(50)
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("system_config")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   @db.VarChar(255)
  entity    String   @db.VarChar(255)
  entityId  String?  @db.VarChar(255)
  changes   Json?
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
